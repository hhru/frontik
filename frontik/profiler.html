
<div id="Frontik-Profiler-Component" class="noprint frontik-profiler">
    <span class="frontik-profiler__total_time">
        Время генерации страницы: <span id="Frontik-Profiler-Total-Time"></span>&#160;
        <a href="#" id="Frontik-Profiler-Toggle-Table-Button" onclick="return FrontikProfilerComponent.toggleTable(this)">Подробнее »</a>
    </span>
    <span class="Frontik-Profiler-Button-Close frontik-profiler__button_close" onclick="FrontikProfilerComponent.close()">x</span>
    <table id="Frontik-Profiler-Component-Table"></table>
</div>

<script type="text/javascript">

    var FrontikProfilerComponent;

    (function() {

        FrontikProfilerComponent = {
            ROW_TEMPLATE:
                ['<tr class="frontik-profiler__stage">',
                    '<td class="frontik-profiler__stage_name_cell">',
                        '<a href="#" class="frontik-profiler__stage_name" onclick="return FrontikProfilerComponent.toggleDetailed(this)">',
                            '{{=name}}',
                        '</a>',
                    '</td>',
                    '<td>',
                        '<div class="frontik-profiler__stage_bar" title="{{=delta}} ms" ',
                            'style="left: {{=left}}%; width: {{=width}}%">',
                            '&#160;',
                        '</div>',
                    '</td>',
                '</tr>',
                '<tr class="frontik-profiler__stage_info">',
                    '<td colspan="2">Время: {{=delta}} ms</td>',
                '</tr>'].join(''),

            totalTime: null,

            init: function(data, options) {
                var profiler = document.getElementById('Frontik-Profiler-Component');
                var profilerTable = document.getElementById('Frontik-Profiler-Component-Table');
                var stageRows = '';

                this.totalTime = data['total']['delta'];

                for (var s in data) {
                    if (s === 'total') continue;
                    stageRows += this.getStageHtml(s, data[s]);
                }

                profilerTable.innerHTML = stageRows;
                document.getElementById('Frontik-Profiler-Total-Time').innerText = this.totalTime + ' ms';

                setCookie('debug', 'profile');
                if (getCookie('frontik-profiler') === 'show') {
                    addClass(profilerTable, 'visible');
                    document.getElementById('Frontik-Profiler-Toggle-Table-Button').innerText = 'Скрыть «';
                }

                document.body.insertBefore(profiler, document.body.firstChild);
                addClass(profiler, 'visible');
            },

            getStageHtml: function(stageName, stageData) {
                return tmpl(this.ROW_TEMPLATE, {
                    width: 100 * stageData['delta'] / this.totalTime,
                    left: 100 * stageData['start'] / this.totalTime,
                    delta: stageData['delta'],
                    name: stageName
                });
            },

            close: function() {
                setCookie('debug', '', -1);
                var profiler = document.getElementById('Frontik-Profiler-Component');
                profiler.parentNode.removeChild(profiler);
            },

            toggleDetailed: function(e) {
                var detailedInfo = e.parentNode.parentNode.nextSibling;
                toggleClass(detailedInfo, 'visible');
                return false;
            },

            toggleTable: function(e) {
                var profilerTable = document.getElementById('Frontik-Profiler-Component-Table');

                if (hasClass(profilerTable, 'visible')) {
                    e.innerText = 'Подробнее »';
                    setCookie('frontik-profiler', '', -1);
                } else {
                    e.innerText = 'Скрыть «';
                    setCookie('frontik-profiler', 'show');
                }

                toggleClass(profilerTable, 'visible');
                return false;
            }
        };

        contentLoaded(window, function() {
            FrontikProfilerComponent.init('<%FrontikProfilerData%>', '<%FrontikProfilerOptions%>');
        });

        /* Class manipulation functions (based on jQuery implementation) */

        function toggleClass(elem, className) {
            hasClass(elem, className) ? removeClass(elem, className) : addClass(elem, className);
        }

        function hasClass(elem, className) {
            return (' ' + elem.className + ' ').replace(/[\t\r\n]/g, ' ').indexOf(' ' + className + ' ') >= 0;
        }

        function addClass(elem, className) {
            elem.className += ' ' + className;
        }

        function removeClass(elem, className) {
            if (!elem.className) return;
            var elementClass = (' ' + elem.className + ' ').replace(/[\t\r\n]/g, ' ');
            while (elementClass.indexOf(' ' + className + ' ') >= 0)
                elementClass = elementClass.replace(' ' + className + ' ' , ' ');
            elem.className = elementClass.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
        }

        /* JSX cookie utils */

        function setCookie(name, value, time) {
            var cookie = name + '=' + (value || '') + ';path=/';

            if (typeof(time) != 'undefined') {
                var expire = new Date();
                expire.setTime(expire.getTime() + time * 3600000);
                cookie += ';expires=' + expire.toGMTString();
            }

            document.cookie = cookie;
        }

        function getCookie(name) {
            var kukki = document.cookie;
            var index = kukki.indexOf(name + '=');
            if (index == -1) return null;

            index = kukki.indexOf('=', index) + 1;
            var endstr = kukki.indexOf(';', index);
            if (endstr == -1)
                endstr = kukki.length;

            return decodeURIComponent(kukki.substring(index, endstr));
        }

        /*
        * Simple JavaScript Templating
        * John Resig - http://ejohn.org/ - MIT Licensed
        */

        (function(){
            var cache = {};
            this.tmpl = function tmpl(str, data){
                var fn = !/\W/.test(str) ?
                cache[str] = cache[str] ||
                    tmpl(document.getElementById(str).innerHTML) :
                    new Function("obj",
                        "var p=[]; with(obj){p.push('" +
                        str
                            .replace(/[\r\t\n]/g, " ")
                            .split("{{").join("\t")
                            .replace(/((^|}})[^\t]*)'/g, "$1\r")
                            .replace(/\t=(.*?)}}/g, "',$1,'")
                            .split("\t").join("');")
                            .split("}}").join("p.push('")
                            .split("\r").join("\\'")
                        + "');}return p.join('');");

                return data ? fn( data ) : fn;
            };
        })();

        /*!
        * contentloaded.js
        *
        * Author: Diego Perini (diego.perini at gmail.com)
        * Summary: cross-browser wrapper for DOMContentLoaded
        * Updated: 20101020
        * License: MIT
        * Version: 1.2
        *
        * URL:
        * http://javascript.nwbox.com/ContentLoaded/
        * http://javascript.nwbox.com/ContentLoaded/MIT-LICENSE
        */

        function contentLoaded(win, fn) {
            var done = false, top = true,
            doc = win.document, root = doc.documentElement,
            add = doc.addEventListener ? 'addEventListener' : 'attachEvent',
            rem = doc.addEventListener ? 'removeEventListener' : 'detachEvent',
            pre = doc.addEventListener ? '' : 'on',

            init = function(e) {
                if (e.type == 'readystatechange' && doc.readyState != 'complete') return;
                (e.type == 'load' ? win : doc)[rem](pre + e.type, init, false);
                if (!done && (done = true)) fn.call(win, e.type || e);
            },

            poll = function() {
                try { root.doScroll('left'); } catch(e) { setTimeout(poll, 50); return; }
                init('poll');
            };

            if (doc.readyState == 'complete') fn.call(win, 'lazy');
            else {
                if (doc.createEventObject && root.doScroll) {
                    try { top = !win.frameElement; } catch(e) { }
                    if (top) poll();
                }
                doc[add](pre + 'DOMContentLoaded', init, false);
                doc[add](pre + 'readystatechange', init, false);
                win[add](pre + 'load', init, false);
            }
        }

    })();

</script>

<style>

    .frontik-profiler {
        display: none;
        width: 60%;
        margin: 0 auto;
        margin-bottom: 12px;
        padding: 5px 10px;
        border: 1px solid #999;
        border-top: none;
        font-family: Arial, Verdana, Helvetica, sans-serif;
        font-size: 12px;
        background: #fff;
        line-height: 20px;
        box-shadow: -1px 2px 10px -3px #333;
        z-index: 1234567;
    }

        .frontik-profiler.visible {
            display: block;
        }

        .frontik-profiler__total_time {
            padding-left: 2px;
        }

            .frontik-profiler__total_time span {
                display: inline-block;
                margin-left: 4px;
                margin-right: 10px;
                padding: 0 3px;
                background: #5bb75b;
                color: #fff;
                border-radius: 4px;
            }

                .frontik-profiler__total_time span.warning {
                    background: #faa732;
                }

                .frontik-profiler__total_time span.critical {
                    background: #da4f49;
                }

        .frontik-profiler table {
            display: none;
            width: 100%;
            margin-top: 6px;
            border-collapse: collapse;
        }

            .frontik-profiler table.visible {
                display: table;
            }

            .frontik-profiler tr:nth-child(4n+1), .frontik-profiler tr:nth-child(4n+2) {
                background: #eef;
            }

            .frontik-profiler__stage_info {
                display: none;
            }

                .frontik-profiler__stage_info.visible {
                    display: table-row;
                }

                .frontik-profiler__stage_info td {
                    padding: 0 3px;
                }

            .frontik-profiler__stage_name_cell {
                width: 60px;
                padding: 0 3px;
            }

                .frontik-profiler__stage_name {
                    display: block;
                    width: 60px;
                    text-overflow: ellipsis;
                    overflow: hidden;
                }

            .frontik-profiler__stage .frontik-profiler__stage_bar {
                position: relative;
                text-align: center;
                white-space: nowrap;
                background: #006dcc;
            }

        .frontik-profiler__button_close {
            display: block;
            float: right;
            margin-top: -1px;
            padding-right: 3px;
            text-decoration: none;
            cursor: pointer;
        }

            .frontik-profiler__button_close:hover {
                color: #c00;
            }

</style>
